generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ===================== */
/* Roles & Users         */
/* ===================== */

enum Role {
  ADMIN
  VENDOR
  CUSTOMER
}

model User {
  id           String   @id @default(cuid())
  name         String?
  email        String?  @unique
  passwordHash String?
  role         Role     @default(CUSTOMER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  accounts Account[]
  sessions Session[]

  carts Cart[]
  orders Order[]
  timelineEvents FulfillmentEvent[]
  adminActions AdminAction[]
}

/* ===================== */
/* NextAuth tables       */
/* ===================== */

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?
  refresh_token     String?
  expires_at        Int?
  token_type        String?
  scope             String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/* ===================== */
/* Products / Cart       */
/* ===================== */

model Product {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String
  shortDescription String?
  price            Float
  discountPrice    Float?
  stock            Int      @default(0)
  sortOrder        Int      @default(0)
  unit             String?

  mainImage        String
  gallery          String[]
  category         String?
  tags             String[] @default([])

  isFeatured       Boolean  @default(false)
  sku              String?
  rating           Float?   @default(0)
  reviewsCount     Int?     @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cartItems CartItem[]
  orderItems OrderItem[]
}

model Cart {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  quantity  Int     @default(1)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
}

/* ===================== */
/* Orders + Payments     */
/* ===================== */

enum OrderStatus {
  PENDING
  PAID
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  RETURNED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUND_PENDING
  REFUNDED
}

model Order {
  id            String        @id @default(cuid())
  orderNumber   String        @unique
  userId        String?
  customerName  String?
  customerPhone String?
  customerEmail String?
  address       String?
  totalAmount   Float
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User?         @relation(fields: [userId], references: [id])
  items         OrderItem[]
  payment       Payment? @relation(name: "OrderPayment")
  timeline      FulfillmentEvent[]
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

/* ===================== */
/* Razorpay Payments     */
/* ===================== */

model Payment {
  id                String   @id @default(cuid())
  orderId           String   @unique
  razorpayOrderId   String   @unique
  razorpayPaymentId String?  @unique
  razorpaySignature String?
  amount            Int
  currency          String   @default("INR")
  status            String   @default("created") // created | authorized | captured | failed | refunded
  method            String?
  email             String?
  contact           String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  capturedAt        DateTime?

  order           Order @relation(name: "OrderPayment", fields: [orderId], references: [id])
  refunds         Refund[]
}

model Refund {
  id                String   @id @default(cuid())
  paymentId         String
  razorpayRefundId  String   @unique
  amount            Int
  status            String   // pending | processed | failed
  reason            String?
  createdAt         DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id])
}

/* ===================== */
/* Webhooks & Events    */
/* ===================== */

model WebhookEvent {
  id         String   @id @default(cuid())
  provider   String   @default("razorpay")
  event      String
  externalId String?
  payload    Json
  headers    Json
  processed  Boolean  @default(false)
  error      String?
  receivedAt DateTime @default(now())
}

/* Zomato/Swiggy style order timeline */
model FulfillmentEvent {
  id        String       @id @default(cuid())
  orderId   String
  status    OrderStatus
  note      String?
  meta      Json?
  createdAt DateTime     @default(now())
  actorId   String?
  
  order     Order @relation(fields: [orderId], references: [id])
  actor     User? @relation(fields: [actorId], references: [id])
}

/* Admin manual actions log */
model AdminAction {
  id        String     @id @default(cuid())
  adminId   String
  orderId   String?
  action    String
  reason    String?
  createdAt DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id])
}
